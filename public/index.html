<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FishTrade — Предложения рыбы</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<header>
  <h1>Оптовые цены напрямую от производителей</h1>
  <p>Без посредников. Честные условия. Быстрая доставка.</p>
  <form id="searchForm" role="search" onsubmit="event.preventDefault();state.q=this.q.value.toLowerCase();renderProducts();">
    <input name="q" id="searchInput" placeholder="Поиск" aria-label="Поиск"/>
  </form>
  <div id="chips" class="chips" role="list"></div>
  <div class="sort">
    <select id="sortSelect" aria-label="Сортировка" onchange="changeSort(this.value)">
      <option value="priceAsc">Дешевле</option>
      <option value="priceDesc">Дороже</option>
      <option value="freshFirst">Свежая</option>
      <option value="ratingDesc">Лучший поставщик</option>
    </select>
  </div>
</header>
<main>
  <ul id="cards" class="cards" role="list"></ul>
</main>
<div id="buyBar" class="buy-bar hidden" aria-hidden="true">
  <div class="info"></div>
  <button class="btn primary" onclick="openQuickOrder(state.selected)">Купить</button>
</div>
<div id="quickModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-content">
    <h2>Быстрая заявка</h2>
    <form id="quickForm">
      <label>Имя<input name="name" required minlength="2"></label>
      <label>Телефон<input name="phone" type="tel" pattern="[\d\+\-\s]{6,}" required></label>
      <label>Кол-во, кг
        <div class="stepper">
          <button type="button" onclick="stepQty(-10)">-10</button>
          <button type="button" onclick="stepQty(-1)">-1</button>
          <input name="qty" type="number" min="1" value="1">
          <button type="button" onclick="stepQty(1)">+1</button>
          <button type="button" onclick="stepQty(10)">+10</button>
        </div>
      </label>
      <label>Комментарий (необязательно)<textarea name="note"></textarea></label>
      <div class="modal-actions">
        <button type="submit" class="btn primary">Отправить заявку</button>
        <button type="button" class="btn secondary" onclick="closeQuick()">Отмена</button>
      </div>
    </form>
    <div id="success" class="success hidden">Заявка принята. Мы свяжемся с вами.</div>
  </div>
</div>
<script>
const state={products:[],filter:'',q:'',sort:'priceAsc',selected:null};
async function loadProducts(){
  const list=document.getElementById('cards');
  list.innerHTML='<li class="card skeleton"></li><li class="card skeleton"></li><li class="card skeleton"></li>';
  const res=await fetch('/api/products?sort='+state.sort);
  const data=await res.json();
  state.products=data;
  buildFilters();
  renderProducts();
}
function buildFilters(){
  const sp=[...new Set(state.products.map(p=>p.species))];
  const chips=document.getElementById('chips');
  chips.innerHTML='<button class="chip" onclick="resetFilters()">Сбросить</button>'+
    sp.map(s=>`<button class="chip" onclick="applyFilter('${s}')">${s}</button>`).join('');
}
function applyFilter(s){state.filter=s;console.log('apply_filter',s);renderProducts();}
function resetFilters(){state.filter='';state.q='';document.getElementById('searchInput').value='';renderProducts();}
function changeSort(v){state.sort=v;loadProducts();}
function renderProducts(){
  const list=document.getElementById('cards');
  let arr=state.products;
  if(state.filter) arr=arr.filter(p=>p.species===state.filter);
  if(state.q) arr=arr.filter(p=>[p.species,p.form,p.loc,p.seller].some(v=>String(v).toLowerCase().includes(state.q)));
  if(!arr.length){list.innerHTML='<li class="muted">Ничего не найдено</li>';return;}
  list.innerHTML=arr.map(p=>renderCard(p)).join('');
}
function renderCard(p){return `<li class="card" role="listitem">
  <div class="row"><h3>${p.species} · ${p.form}</h3><div class="price">$${p.price}/кг</div></div>
  <div class="meta">Мин. заказ: ${p.min} кг • Доступно: ${p.stock} кг • ${p.loc}</div>
  <div class="seller">Поставщик: ${p.seller} • ⭐ ${p.rating}</div>
  <div class="actions">
    <button class="btn primary" onclick="buyNow('${p.id}')">Купить</button>
    <button class="btn secondary" onclick="console.log('click_rfq','${p.id}')">Запрос цены</button>
  </div>
</li>`;}
function showBuyBar(){const bar=document.getElementById('buyBar');if(!state.selected){bar.classList.add('hidden');return;}bar.querySelector('.info').textContent=`${state.selected.species} · ${state.selected.form} — $${state.selected.price}/кг`;bar.classList.remove('hidden');}
function buyNow(id){const p=state.products.find(x=>x.id===id);if(!p)return;state.selected=p;showBuyBar();console.log('click_buy',id);openQuickOrder(p);}
function openQuickOrder(p){const m=document.getElementById('quickModal');const f=document.getElementById('quickForm');m.classList.remove('hidden');f.qty.value=p.min;}
function closeQuick(){document.getElementById('quickModal').classList.add('hidden');}
function stepQty(d){const f=document.getElementById('quickForm');f.qty.value=Math.max(state.selected.min,Number(f.qty.value)+d);}
document.getElementById('quickForm').addEventListener('submit',submitQuick);
async function submitQuick(e){e.preventDefault();const f=e.target;const name=f.name.value.trim();const phone=f.phone.value.trim();const qty=Number(f.qty.value);if(name.length<2||!/^[\d\+\-\s]{6,}$/.test(phone)||qty<state.selected.min){alert('Проверьте данные');return;}const note=f.note.value.trim();const buyer={name,phone,note};const itemTitle=`${state.selected.species} · ${state.selected.form}`;const payload={items:[{title:itemTitle,qty,price:state.selected.price}],total:qty*state.selected.price,buyer};const r=await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(r.ok){console.log('submit_quick_order',payload);f.reset();document.getElementById('success').classList.remove('hidden');setTimeout(()=>{document.getElementById('success').classList.add('hidden');closeQuick();state.selected=null;showBuyBar();},1500);}else{alert('Что-то пошло не так. Попробуйте ещё раз');}}
document.addEventListener('DOMContentLoaded',loadProducts);
</script>
</body>
</html>
